---
title: "AS evolution with arcan jgit"
author: "RR"
date: "13th December 2016"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


#AS-evolution
Note: split fullname classes <http://stackoverflow.com/questions/24938616/string-split-on-last-comma-in-r/>

Read *class metric* file from csv and print summary
```{r Reading csv of class metrics}
knitr::opts_chunk$set(cache=TRUE)#attivata la cache del markdown
# setAs("character","myDate", function(from) as.Date(from, format="%Y-%m-%dT%H:%M:%S"))
# classmetrics <- read.csv(file="data/jgit/CM.csv",colClasses=c('character','myDate','character','numeric','numeric','numeric','numeric'),head=TRUE,sep=",")
to.timestamp <- function(d) as.POSIXct(d, format="%Y-%m-%dT%H:%M:%S")
to.timestamp.fromint <- function(d) as.POSIXct(d,origin = "1970-01-01", tz = "GMT")
library(data.table)
classmetrics<-fread("data/tomcat/CM.csv")
#strsplit(x=classmetrics$Class,split=)
library(stringr)
appo <- str_split_fixed(classmetrics$Class, "\\.\\s*(?=[^\\.]+$)", 2)
head(appo)
classmetrics$package <- appo[,1]
classmetrics$className <- appo[,2]
rm(appo)
classmetrics$commit_time <- to.timestamp(classmetrics$commit_time)
# names(classmetrics)
# summary(classmetrics)
# head(classmetrics)
library(plyr)
#group by  package
# groupclassmetrics <-ddply(classmetrics,
#                           .(package,version,commit_time),
#                           summarise,
#                           meanCBO=mean(CBO),sdCBO=sd(CBO),maxCBO=max(CBO),minCBO=min(CBO),
#                           meanLCOM=mean(LCOM),sdLCOM=sd(LCOM),maxLCOM=max(LCOM),minLCOM=min(LCOM),
#                           meanFI=mean(FI),sdFI=sd(FI),maxFI=max(FI),minFI=min(FI),
#                           meanFO=mean(FO),sdFO=sd(FO),maxFO=max(FO),minFO=min(FO),
#                           numClasses=length(unique(Class)))
# groupclassmetrics<-classmetrics[,
#                            .(meanCBO=mean(CBO),sdCBO=sd(CBO),maxCBO=max(CBO),minCBO=min(CBO),
#                              meanLCOM=mean(LCOM),sdLCOM=sd(LCOM),maxLCOM=max(LCOM),minLCOM=min(LCOM),
#                              meanFI=mean(FI),sdFI=sd(FI),maxFI=max(FI),minFI=min(FI),
#                              meanFO=mean(FO),sdFO=sd(FO),maxFO=max(FO),minFO=min(FO),
#                              numClasses=length(unique(Class))),
#                            .(package,version,commit_time)]
# head(groupclassmetrics)
# rm(groupclassmetrics)
```

Read *class cycle* from csv and print summary, put cicle item (after circle, star and chain) *\"* and at the end of every lines. search *$* and write *\"* in replace all field, then press replace all, Last add a new column classes
```{r Reading file csv of cycle among classes}
library(tidyr)
shapes <- c("circle", "tiny", "star","chain", "clique")
clcycle <- fread("data/tomcat/classCL.csv")
clcycle <- separate_rows(clcycle, ElementList, sep = ",")
clcycle$CycleType <- factor(clcycle$CycleType, shapes)
clcycle$commit_time <-  to.timestamp(clcycle$commit_time)
library(stringr)
appocy <- str_split_fixed(clcycle$ElementList, "\\.\\s*(?=[^\\.]+$)", 2)
head(appocy)
clcycle$package <- appocy[,1]
clcycle$className <- appocy[,2]
rm(appocy)
clcycle$CD <- 1
names(clcycle)
head(clcycle)
```
##merging by metrics and cycle at class level (left outer join)
```{r Merging class cycle and metrics at class level}
clcycle[, 
        `:=`(star=ifelse(as.character(CycleType)=="star",1,0),
        tiny=ifelse(as.character(CycleType)=="tiny",1,0),
        chain=ifelse(as.character(CycleType)=="chain",1,0),
        clique=ifelse(as.character(CycleType)=="clique",1,0),
        circle=ifelse(as.character(CycleType)=="circle",1,0))]

clcycletype<- clcycle[,
                      .(star=sum(star),
                        tiny=sum(tiny),
                        chain=sum(chain),
                        clique=sum(clique),
                        circle=sum(circle),
                        CD = sum(CD)),
                      .(version,commit_time,package,className)]
setkey(clcycletype,"version", "commit_time","package","className")
setkey(classmetrics,"version", "commit_time","package","className")
class.cycle.metric.merging<-clcycletype[classmetrics, roll=TRUE]
class.cycle.metric.merging<-subset(class.cycle.metric.merging, select=-c( Class))
class.cycle.metric.merging[is.na(class.cycle.metric.merging)] <- 0
#Clean memory from no-more used datasets
rm(clcycle)
rm(clcycletype)
rm(classmetrics)
```

Read *ixpd* from csv and print summary
```{r Reading IXPD csv}
ixpd <- fread(file="data/tomcat/tomcat_IXPD_2.csv")
ixpd <- rename(ixpd, replace = c("java-out" = "java.out", "java-in"="java.in","commit-out"="commit.out","commit-in"="commit.in","ratio-out"="ratio.out","ratio-in"="ration.in"))
ixpd$java.out<-gsub("\\/",".",gsub("^.*(java|test|WEB-INF)\\/", "", gsub("\\.java", "", ixpd$java.out)))
ixpd$java.in<-gsub("\\/",".",gsub("^.*(java|test|WEB-INF)\\/", "", gsub("\\.java", "", ixpd$java.in)))
ixpd$commit_time<-to.timestamp.fromint(ixpd$commit_time)
library(stringr)
appoixpdin <- str_split_fixed(ixpd$java.in, "\\.\\s*(?=[^\\.]+$)", 2)
appoixpdout <- str_split_fixed(ixpd$java.out, "\\.\\s*(?=[^\\.]+$)", 2)
# str_split_fixed(ixpd$java.out, "\\.", 2)
head(appoixpdin)
head(appoixpdout)
ixpd$package.in <- gsub("^.*(java|test|WEB-INF)\\.", "", appoixpdin[, 1])
ixpd$className.in <- appoixpdin[,2]
ixpd$package.out <- gsub("^.*(java|test|WEB-INF)\\.", "", appoixpdout[, 1])
ixpd$className.out <- appoixpdout[, 2]
ixpd <- subset(ixpd, select = -c(commit_time))
rm(appoixpdin)
rm(appoixpdout)
ixpd$IXPD <- 1
names(ixpd)
summary(ixpd)
head(ixpd)
```

```{r group to package ixpd}
pkg.ixpd <- ixpd[,.(
      minCommit.out = min(commit.out), maxCommit.out = max(commit.out), meanCommit.out = mean(commit.out),
      minCommit.in = min(commit.in), maxCommit.in = max(commit.in), meanCommit.in = mean(commit.in),
      minRatio.out = min(ratio.out), maxRatio.out = max(ratio.out), meanRatio.out = mean(ratio.out),
      minRatio.in = min(ration.in), maxRatio.in = max(ration.in), meanRatio.in = mean(ration.in),
      numClasses = length(java.in),
      IXPD = length(java.in),
      numPackages = length(unique(package.in))),
      # .(version, commit_time, package.out)
        .(version, package.out)
    ]
#pkg.ixpd <- subset(pkg.ixpd, select = -c(commit_time))
pkg.ixpd <- rename(pkg.ixpd, replace = c("package.out" = "package"))
names(pkg.ixpd)
```


##merging by metrics-cycle with IXPD at class level (left outer join)
```{r Merging class cycle-metrics with IXPD at class level}
setkey(ixpd,"version","package.out","className.out")
setkey(class.cycle.metric.merging,"version","package","className")
class.cycle.metric.ixpd.merging <- ixpd[class.cycle.metric.merging, 
                              # .(version,commit_time,package,className)
                              ,]
class.cycle.metric.ixpd.merging[is.na(class.cycle.metric.ixpd.merging)] <- 0
names(class.cycle.metric.ixpd.merging)
#Clean memory from no-more used datasets
# rm(ixpd)
# rm(class.cycle.metric.merging)
``` 

Read *hub like* from csv and print summary
```{r Reading csv file of hub like AS}
# hublike <- read.csv(file="data/jgit/HL.csv",colClasses=c('character','myDate','character','numeric','numeric','numeric'),head=TRUE,sep=",")
hublike <- fread("data/tomcat/HL.csv")
hublike$commit_time <- to.timestamp(hublike$commit_time)
library(stringr)
appo <- str_split_fixed(hublike$Class, "\\.\\s*(?=[^\\.]+$)", 2)
head(appo)
hublike$package <- appo[,1]
hublike$className <- appo[,2]
rm(appo)
hublike$HL <- 1
hublike <- rename(hublike, replace = c("Total Dependences" = "Total.Dependences"))
grouphublike<-hublike[, .(meanFanIn=mean(FanIn),
                     sdFanIn=sd(FanIn),
                     maxFanIn=max(FanIn),
                     minFanIn=min(FanIn),
                     meanFanOut=mean(FanOut),
                     sdFanOut=sd(FanOut),
                     maxFanOut=max(FanOut),
                     minFanOut=min(FanOut),
                     meanTD=mean(Total.Dependences),
                     sdTD=sd(Total.Dependences),
                     maxTD=max(Total.Dependences),
                     minTD=min(Total.Dependences),
                     numClasses=length(unique(Class)),
                     HL=sum(HL)),
                     .(package,version,commit_time)]
head(grouphublike)
```

##merging by metrics-cycle-IXPD with Hub-Like at class level (left outer join)
```{r Merging class cycle-metrics-IXPD with Hub-Like at class level}
hublike.tmp <- hublike
names(hublike.tmp) <- gsub("^(FanIn|FanOut|Total.Dependences)", "HL\\1", names(hublike))
setkey(hublike.tmp,"version","commit_time","package","className")
setkey(class.cycle.metric.ixpd.merging,"version", "commit_time","package.out","className.out")
class.cycle.metric.ixpd.HL.merging <- hublike.tmp[class.cycle.metric.ixpd.merging, 
                              # .(version,commit_time,package,className)
                              ,]
rm(hublike.tmp)
class.cycle.metric.ixpd.HL.merging[is.na(class.cycle.metric.ixpd.HL.merging)] <- 0
names(class.cycle.metric.ixpd.HL.merging)
summary(class.cycle.metric.ixpd.HL.merging)
head(class.cycle.metric.ixpd.HL.merging)
#Clean memory from no-more used datasets
rm(hublike)
# rm(class.cycle.metric.ixpd.merging)
``` 


Read *unstable dependency* from csv and print summary
```{r Reading fiel csv of unstable dependecies AS}
# unstabledep <- read.csv(file="data/jgit/UD.csv", colClasses=c('character', 'myDate', 'character', 'numeric', 'character', 'numeric'), head=TRUE, sep=",")
library(data.table)
unstabledep <- fread(file="data/tomcat/UD.csv")
unstabledep$commit_time <- to.timestamp(unstabledep$commit_time)
library(stringr)
# appo <- str_split_fixed(unstabledep$UnstableDependenciesPackage, "\\.\\s*(?=[^\\.]+$)", 2)
# unstabledep$package <- appo[,1]
# unstabledep$className <- appo[,2]
library(plyr)
if(empty(unstabledep)){
  unstabledep$UD <- numeric(0)
} else {
  unstabledep$UD <- 1
}
names(unstabledep)
summary(unstabledep)
```

##merging by metrics-cycle-IXPD-Hub-like with Unstable dependencies at class level (left outer join)
```{r Merging class cycle-metrics-IXPD-Hub-like with Unstable dependencies at class level}
class.unstabledep <- if(empty(unstabledep)) {
    data.table(version = NA,
               commit_time = NA,
               UnstableDependenciesPackage = NA,
               InstabilityUnstableDependenciesPackage = NA,
               UDnumCorrelatedPackage = NA,
               UDminInstabilityCorrelatedPackage = NA,
               UDmaxInstabilityCorrelatedPackage = NA,
               UDmeanInstabilityCorrelatedPackage = NA,
               UDsdInstabilityCorrelatedPackage = NA,
               UD = NA)[0:0, ]
} else {
  unstabledep[,
         .(UDnumCorrelatedPackage = length(CorrelatedPackage),
         UDminInstabilityCorrelatedPackage = min(InstabilityCorrelatedPackage),
         UDmaxInstabilityCorrelatedPackage = max(InstabilityCorrelatedPackage),
         UDmeanInstabilityCorrelatedPackage = mean(InstabilityCorrelatedPackage),
         UDsdInstabilityCorrelatedPackage = sd(InstabilityCorrelatedPackage),
         UD = sum(UD)),
          .(version, commit_time, UnstableDependenciesPackage, InstabilityUnstableDependenciesPackage)]
}
names(class.unstabledep)[3]<-"package"
setkey(class.unstabledep,"version","commit_time","package")
setkey(class.cycle.metric.ixpd.HL.merging,"version", "commit_time","package")
class.cycle.metric.ixpd.HL.UD.merging <- class.unstabledep[class.cycle.metric.ixpd.HL.merging ]
class.cycle.metric.ixpd.HL.UD.merging[is.na(class.cycle.metric.ixpd.HL.UD.merging)] <- 0
names(class.cycle.metric.ixpd.HL.UD.merging)
#Clean memory from no-more used datasets
rm(unstabledep)
rm(class.unstabledep)
# rm(class.cycle.metric.ixpd.HL.merging)
``` 

Read *package file* from csv and print summary
```{r Reading csv of package metrics}
# pkgmetrics <- read.csv(file="data/jgit/PM.csv",colClasses=c('character','myDate','character','numeric','numeric','numeric','numeric','numeric'),head=TRUE,sep=",")
pkgmetrics <- fread("data/tomcat/PM.csv")
pkgmetrics$commit_time <- to.timestamp(pkgmetrics$commit_time)
names(pkgmetrics)
summary(pkgmetrics)
head(pkgmetrics)
```


Read *package cycle* from csv and print summary, put cicle item (after circle, star and chain) *\"* and at the end of every lines. search *$* and write *\"* in replace all field, then press replace all, Last add a new column package
```{r Reading file csv of cycle among package}
pkgcycle <- fread("data/tomcat/packageCL.csv")
pkgcycle$commit_time <- to.timestamp(pkgcycle$commit_time)
pkgcycle <- separate_rows(pkgcycle, ElementList, sep = ",")
pkgcycle$CycleType <- factor(pkgcycle$CycleType, shapes)
pkgcycle$CD <- 1
names(pkgcycle)
summary(pkgcycle)
```

##merging by metrics and cycle at package level (left outer join)
```{r Merging class cycle and metrics at package level}
names(pkgcycle)[5]<-"package"
names(pkgmetrics)[3]<-"package"
pkgcycle[,
         `:=`(star=ifelse(as.character(CycleType)=="star",1,0),
              tiny=ifelse(as.character(CycleType)=="tiny",1,0),
              chain=ifelse(as.character(CycleType)=="chain",1,0),
              clique=ifelse(as.character(CycleType)=="clique",1,0),
              circle=ifelse(as.character(CycleType)=="circle",1,0)),]
pkgcycletype<-pkgcycle[,
                       .(star=sum(star),
                         tiny=sum(tiny),
                         chain=sum(chain),
                         clique=sum(clique),
                         circle=sum(circle),
                         CD = sum(CD)),
                       .(version,commit_time,package)]
setkey(pkgcycletype,"version", "commit_time","package")
setkey(pkgmetrics,"version", "commit_time","package")
pkg.cycle.metric.merging<-pkgcycletype[pkgmetrics, roll=TRUE]
pkg.cycle.metric.merging[is.na(pkg.cycle.metric.merging)] <- 0
names(pkg.cycle.metric.merging)
#Clean memory from no-more used datasets
rm(pkgcycle)
rm(pkgcycletype)
rm(pkgmetrics)
```

```{r Merge package hub-like info}
grouphublike.tmp <- grouphublike
names(grouphublike.tmp) <- gsub("^(min|max|sd|mean|num)", "HL\\1", names(grouphublike.tmp))
setkey(pkg.cycle.metric.merging,"version", "commit_time","package")
setkey(grouphublike.tmp,"version", "commit_time","package")
pkg.metric.CD.HL <- grouphublike.tmp[pkg.cycle.metric.merging]
rm(grouphublike.tmp)
pkg.metric.CD.HL[is.na(pkg.metric.CD.HL)] <- 0
names(pkg.metric.CD.HL)
#Clean memory from no-more used datasets
rm(grouphublike)
# rm(pkg.cycle.metric.merging)
```

Read *unstable dependency* from csv and print summary
```{r Reading file csv of unstable dependecies AS second times}
library(data.table)
unstabledep <- fread(file="data/tomcat/UD.csv")
unstabledep$commit_time <- to.timestamp(unstabledep$commit_time)
library(stringr)
library(plyr)
if(empty(unstabledep)){
  unstabledep$UD <- numeric(0)
} else {
  unstabledep$UD <- 1
}
names(unstabledep)
summary(unstabledep)
```

```{r Merge package unstable deps info}
pkg.unstabledep <- if(empty(unstabledep)) {
    data.table(version = NA,
               commit_time = NA,
               UnstableDependenciesPackage = NA,
               InstabilityUnstableDependenciesPackage = NA,
               UDnumCorrelatedPackage = NA,
               UDminInstabilityCorrelatedPackage = NA,
               UDmaxInstabilityCorrelatedPackage = NA,
               UDmeanInstabilityCorrelatedPackage = NA,
               UDsdInstabilityCorrelatedPackage = NA)[0:0, ]
} else {
  unstabledep[,
         .(UDnumCorrelatedPackage = length(CorrelatedPackage),
         UDminInstabilityCorrelatedPackage = min(InstabilityCorrelatedPackage),
         UDmaxInstabilityCorrelatedPackage = max(InstabilityCorrelatedPackage),
         UDmeanInstabilityCorrelatedPackage = mean(InstabilityCorrelatedPackage),
         UDsdInstabilityCorrelatedPackage = sd(InstabilityCorrelatedPackage)),
          .(version, commit_time, UnstableDependenciesPackage, InstabilityUnstableDependenciesPackage)]
}

names(pkg.unstabledep)[3]<-"package"

setkey(pkg.unstabledep,"version","commit_time","package")
setkey(pkg.metric.CD.HL,"version", "commit_time","package")

pkg.metric.CD.HL.UD <- pkg.unstabledep[pkg.metric.CD.HL ]
pkg.metric.CD.HL.UD[is.na(pkg.metric.CD.HL.UD)] <- 0
#Clean memory from no-more used datasets
rm(pkg.unstabledep)
# rm(pkg.metric.CD.HL)
```


```{r package merge ixpd}
# setkey(pkg.ixpd,"version","commit_time","package")
setkey(pkg.ixpd,"version","package")
# setkey(pkg.metric.CD.HL.UD,"version", "commit_time","package")
setkey(pkg.metric.CD.HL.UD,"version", "package")
pkg.metric.CD.HL.UD.ixpd <- pkg.ixpd[pkg.metric.CD.HL.UD ]
pkg.metric.CD.HL.UD.ixpd[is.na(pkg.metric.CD.HL.UD.ixpd)] <- 0
#Clean memory from no-more used datasets
rm(pkg.ixpd)
# rm(pkg.metric.CD.HL.UD)
```

#Merging
```
Inner join: merge(df1, df2) will work for these examples because R automatically joins the frames by common variable names, but you would most likely want to specify merge(df1, df2, by = "CustomerId") to make sure that you were matching on only the fields you desired. You can also use the by.x and by.y parameters if the matching variables have different names in the different data frames.

Outer join: merge(x = df1, y = df2, by = "CustomerId", all = TRUE)
Left outer: merge(x = df1, y = df2, by = "CustomerId", all.x = TRUE)
Right outer: merge(x = df1, y = df2, by = "CustomerId", all.y = TRUE)
Cross join: merge(x = df1, y = df2, by = NULL)
```
#Class merging dataset and ML with caret






#Package merging dataset and ML with caret





```{r write merged datasets to file}
fwrite(pkg.metric.CD.HL.UD.ixpd, "cache/tomcat/package_merged.csv", append = FALSE)
fwrite(class.cycle.metric.ixpd.HL.UD.merging, "cache/tomcat/class_merged.csv", append = FALSE)
```

```{r developers info}
class.dev = fread("data/tomcat/development.csv")
class.dev$commit_time <- to.timestamp.fromint(class.dev$commit_time)
class.dev <- class.dev[, javafile := gsub("^.*(java|test|WEB-INF)\\.", "", javafile),]
#class.dev <- class.dev[, javafile := gsub("^.*\\.(java|test|WEB-INF)\\.", "", javafile),]
appodev <- str_split_fixed(class.dev$javafile, "\\.\\s*(?=[^\\.]+$)", 2)
class.dev$package <- appodev[, 1]
class.dev$className <- appodev[, 2]

pkg.dev <- class.dev[, .(numjavafile = length(unique(javafile)), nummail = length(unique(mail)), max.file.changed = max(file.changed), sum.added.total = sum(added.total), sum.removed.total = sum(removed.total), sum.added.file = sum(added.file), sum.removed.file = sum(removed.file)), .(version, commit_time, package, author, mail)]
```


```{r package merge dev}
keycols = c("version","package")
setkeyv(pkg.dev, keycols)
setkeyv(pkg.metric.CD.HL.UD.ixpd, keycols)
pkg.dev <- subset(pkg.dev, select = -c(commit_time))
pkg.metric.CD.HL.UD.ixpd.dev <- pkg.dev[pkg.metric.CD.HL.UD.ixpd]
pkg.metric.CD.HL.UD.ixpd.dev[is.na(pkg.metric.CD.HL.UD.ixpd.dev)] <- 0
#Clean memory from no-more used datasets
#rm(pkg.dev)
#rm(pkg.metric.CD.HL.UD.ixpd)
```


```{r write merged datasets to file}
fwrite(pkg.metric.CD.HL.UD.ixpd.dev, "cache/tomcat/package_merged.dev.csv", append = FALSE)
```


